name: Sync and Rebase Deployment

on:
  workflow_dispatch: # Manual trigger for now
  # schedule:
  #   - cron: '0 3 * * *' # Example: run daily at 3 AM

jobs:
  sync_and_rebase:
    if: github.repository_owner == 'MeticulousHome'
    runs-on: ubuntu-latest
    steps:

    - name: Checkout forked repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # Fetch full history

    - name: Set up Git
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/getsentry/self-hosted.git
        git fetch upstream --tags

    - name: Get latest upstream tag
      id: latest_tag
      run: |
        LATEST_TAG=$(git tag --list --sort=-v:refname | grep -E '^[0-9]{2}\.[0-9]+\.[0-9]+$' | head -n 1)
        echo "Latest tag is $LATEST_TAG"
        echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

    # - name: Fetch upstream tag commit
    #   run: |
    #     git fetch upstream tag ${{ steps.latest_tag.outputs.tag }}

    # - name: Checkout deployment branch
    #   run: git checkout deployment

    # - name: Rebase deployment branch onto latest tag
    #   run: |
    #     git rebase upstream/${{ steps.latest_tag.outputs.tag }}

    # - name: Append tag to changelog
    #   run: |
    #     echo "${{ steps.latest_tag.outputs.tag }}" >> changelog_versions.txt

    # - name: Push changes
    #   env:
    #     GH_TOKEN: ${{ secrets.GH_PAT }}
    #   run: |
    #     git push origin deployment --force
    #     git add changelog_versions.txt
    #     git commit -m "chore: update to tag ${{ steps.latest_tag.outputs.tag }}"
    #     git push origin HEAD
